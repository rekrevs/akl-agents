# Build System Integration Issue

**Date:** 2025-11-05
**Status:** ⚠️ **IDENTIFIED - Needs Fix**

---

## Problem

The x86-64 port works when building directly in `emulator/` directory, but **FAILS** when using the standard `./configure; make` process documented in README.

---

## Root Cause

### What I Did Wrong

I modified `emulator/Makefile` directly:
```makefile
CFLAGS = -g -fgnu89-inline
AGENTSFLAGS = -DMETERING -DNDEBUG -DNOBIGNUM
```

### What Actually Happens

When running `./configure; make`:

1. `configure` generates root `Makefile` from `Makefile.in`
2. Root `Makefile` invokes emulator build with **overridden variables**:
   ```bash
   cd emulator; \
   gmake CFLAGS="-O2" AGENTSFLAGS="-DNOBIGNUM -DMETERING -DNDEBUG" ...
   ```
3. The CFLAGS from root **override** the emulator/Makefile settings
4. Build proceeds without `-fgnu89-inline`
5. **Linking fails** with undefined references to FD inline functions

---

## Test Results

### Direct Build (emulator/ directory)
```bash
$ cd emulator
$ make
```
**Result:** ✅ **SUCCESS** - Uses emulator/Makefile settings

### Standard Build (root directory)
```bash
$ ./configure --without-gmp
$ make
```
**Result:** ❌ **FAILURE**
```
/usr/bin/ld: undefined reference to `get_dom'
collect2: error: ld returned 1 exit status
```

---

## The Issue: Variable Override

From root `Makefile` line ~165:
```makefile
make-emulator:
	(cd emulator; \
	 $(MAKE) $(VARS_TO_PASS) \
		 AGENTSFLAGS="$(AGENTSFLAGS_GMP) $(AGENTSFLAGS_MATH) $(AGENTSFLAGS_FEATURE)" \
		 agents; \
	 ...)
```

Where `$(VARS_TO_PASS)` includes:
```makefile
CFLAGS="$(CFLAGS)"
```

And configure.in sets:
```bash
if [[ ${GCC} ]] ; then
  CFLAGS=-O2    # <-- This overrides emulator/Makefile!
fi
```

---

## Why -fgnu89-inline Is Needed

**Problem:** FD module uses K&R-style inline functions:
```c
// fd.c
inline bool in_dom(int val, domain *d) { ... }
inline domain *get_dom(cell x) { ... }
```

**Modern GCC behavior:**
- Without `-fgnu89-inline`: Inline functions treated as C99 style
- C99 inline: Function definitions don't emit standalone copies
- Result: Linker can't find function definitions → undefined reference errors

**Fix:** Add `-fgnu89-inline` to force GNU89 inline semantics where inline functions ARE emitted as linkable symbols.

---

## Proper Solution

Need to modify the **build system source files**, not generated files:

### Option 1: Modify configure.in
Add `-fgnu89-inline` when GCC is detected:
```bash
if [[ ${GCC} ]] ; then
  CFLAGS="-O2 -fgnu89-inline"
fi
```

### Option 2: Modify Makefile.in
Add platform-specific or GCC-specific flags in the template.

### Option 3: Create emulator/Makefile.in
Make emulator/Makefile a generated file with proper flag substitution.

---

## Impact

**Currently:**
- ✅ Build works if you directly `cd emulator && make`
- ❌ Build fails if you follow README: `./configure; make`

**This affects:**
- Anyone trying to build from a fresh checkout
- Automated build systems
- Distribution packaging
- Any future porters following standard procedures

---

## Next Steps

1. ✅ Identify the issue
2. ⏳ Choose proper fix location (configure.in vs Makefile.in)
3. ⏳ Implement fix
4. ⏳ Test `./configure; make` works
5. ⏳ Verify direct emulator/ build still works
6. ⏳ Document build process

---

## Files Involved

**Source files (need modification):**
- `configure.in` - Autoconf input, generates `configure`
- `Makefile.in` - Root makefile template, generates `Makefile`

**Generated files (DO NOT modify):**
- `Makefile` - Generated by configure from Makefile.in
- `configure` - Generated by autoconf from configure.in

**Source files (correct place for code changes):**
- `emulator/Makefile` - NOT generated, but gets variables overridden by root

---

## Conclusion

The x86-64 port code changes are correct, but the build system integration is incomplete. The `-fgnu89-inline` flag needs to be added to the proper source file so it gets used when building via `./configure; make`.

**Status:** Build system fix required for proper integration.
