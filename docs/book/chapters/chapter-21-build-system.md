# Chapter 21: Build System

## Introduction

AGENTS uses a traditional **autoconf-based build system** from the early 1990s. The system is designed to configure and compile AGENTS across multiple UNIX platforms with varying compilers, libraries, and system capabilities.

The build system has three main components:
1. **configure** script: Detects platform, compiler, and available features
2. **Makefile hierarchy**: Builds emulator, compiler, library, and demos
3. **Installation system**: Installs AGENTS to a prefix directory

This chapter documents how the build system works, how to use it, and how to extend it for new platforms.

## Overview

### Build Process

**Typical user workflow**:
```sh
./configure --without-gmp
make
make install
```

**What happens**:
1. `./configure` runs platform detection and generates `Makefile`
2. `make` builds emulator, compiler, environment, library, and demos
3. `make install` installs to `/usr/local` (or specified prefix)

### Key Files

**Configuration**:
- `configure.in`: Source for configure script (autoconf input)
- `configure`: Generated configuration script
- `config.guess`: Detects platform automatically
- `config.sub`: Validates and canonicalizes platform names

**Makefiles**:
- `Makefile.in`: Root makefile template
- `emulator/Makefile`: Emulator build rules (not .in)
- `oldcompiler/Makefile.in`: Compiler build rules
- `library/Makefile.in`: Library build rules
- `demos/Makefile.in`: Demo programs build rules

**Generated**:
- `Makefile`: Root makefile (generated by configure)
- `config.status`: Records configuration choices

## The configure Script

### Purpose

The `configure` script:
1. **Detects the platform** (CPU architecture, OS, version)
2. **Finds required tools** (C compiler, make, install)
3. **Checks for features** (hyperbolic math functions, GMP library)
4. **Generates Makefile** from Makefile.in with platform-specific settings

### Invocation

**Basic usage**:
```sh
./configure
```

**With options**:
```sh
./configure --without-gmp --without-fd --prefix=/opt/agents
```

**With explicit host** (cross-compilation):
```sh
./configure --host=aarch64-linux-gnu
```

### Command-Line Options

**From configure.in:50-71** (GMP exclusion):

**`--without-gmp`**: Disable bignum support
```sh
./configure --without-gmp
```

**Effect**:
- Sets `CFLAGS_GMP=""` (no include path)
- Sets `LDFLAGS_GMP=""` (no GMP linking)
- Sets `AGENTSFLAGS_GMP=-DNOBIGNUM` (disable bignums in code)
- Skips building GMP library

**Reason**: The bundled GMP library from 1990s doesn't compile on modern systems. AGENTS works fine without it on 64-bit platforms (58-bit small integers are usually sufficient).

**`--without-fd`**: Disable finite domain constraint solver (similar mechanism)

**`--prefix=DIR`**: Installation directory
```sh
./configure --prefix=/opt/agents
```

**Default**: `/usr/local`

**`--host=PLATFORM`**: Specify target platform explicitly
```sh
./configure --host=x86_64-linux-gnu
```

### Platform Detection

**Automatic detection** (from configure.in:30-47):

```sh
if test -z "${host}" ; then
  host=`${srcdir}/config.guess`
  if test -z "${host}" ; then
    echo "{FATAL: unknown hosttype - see README}"
    exit 1
  fi
fi
```

**Process**:
1. If `--host` not specified, run `config.guess`
2. `config.guess` examines system (uname, processor, etc.)
3. Returns canonical name: `cpu-vendor-os`

**Examples**:
- `x86_64-unknown-linux-gnu`
- `aarch64-apple-darwin24.1.0`
- `sparc-sun-solaris2.5`
- `mips-sgi-irix6.2`

**Validation** (from configure.in:37-46):
```sh
tmphost=`${srcdir}/config.sub $host 2>&1`
case ${tmphost} in
  Invalid* )
    echo "{FATAL: unknown hosttype $host - see README}"
    exit 1
  ;;
  * )
    host=${tmphost}
  ;;
esac
```

`config.sub` canonicalizes and validates platform names.

### Compiler Detection

**From configure.in:73**:
```sh
AC_PROG_CC
```

**Effect**:
- Looks for `gcc`, `cc`, `c89`, etc.
- Sets `CC` variable
- Sets `GCC` variable if compiler is GCC

**Default CFLAGS** (from configure.in:78-82):
```sh
if [[ ${GCC} ]] ; then
  CFLAGS=-O2
else
  CFLAGS=""
fi
```

For GCC: `-O2` optimization by default.
For other compilers: Let user specify.

**Modern addition** (from emulator/Makefile:8):
```sh
CFLAGS = -g -fgnu89-inline
```

The `-fgnu89-inline` flag is **critical** for modern GCC (5.0+) to preserve legacy inline semantics. Without it, compilation fails due to multiple definition errors.

### Feature Detection

**Math library functions** (from configure.in:87-132):

**Problem**: HP-UX systems lack `asinh()`, `acosh()`, `atanh()` on some models.

**Detection**:
```sh
case ${host} in
  m68k-hp-hpux* )
    AGENTSFLAGS_MATH=-DNOASINH
    LDFLAGS_MATH=-lm
    echo "{NOTE: acosh, asinh, and atanh unavailable}"
  ;;
  hppa*-hp-hpux* )
    AGENTSFLAGS_MATH=-DNOASINH
    LDFLAGS_MATH=-lm
    echo "{NOTE: acosh, asinh, and atanh unavailable}"
  ;;
  * )
    AGENTSFLAGS_MATH=""
    LDFLAGS_MATH=-lm
  ;;
esac
```

**Workaround**: Set `-DNOASINH` flag, which causes `builtin.c` to provide error messages instead of calling unavailable functions.

### Tool Detection

**Make** (from configure.in:136):
```sh
AC_PROGRAM_CHECK(MAKE,gmake,gmake,make)
```

**Prefer gmake** (GNU make) on systems where default `make` is limited (HP-UX).

**Install** (from configure.in:85):
```sh
AC_PROG_INSTALL
```

Finds `install` program and sets:
- `INSTALL`
- `INSTALL_DATA`
- `INSTALL_PROGRAM`

### Output Generation

**From configure.in:138**:
```sh
AC_OUTPUT(Makefile)
```

**Process**:
1. Reads `Makefile.in` template
2. Substitutes `@VARIABLE@` placeholders with detected values
3. Writes `Makefile`

**Substituted variables**:
- `@CC@` → detected C compiler
- `@CFLAGS@` → detected compiler flags
- `@CFLAGS_GMP@` → GMP include flags
- `@LDFLAGS_GMP@` → GMP linking flags
- `@LDFLAGS_MATH@` → Math library flags
- `@AGENTSFLAGS_GMP@` → Bignum disable flag
- `@AGENTSFLAGS_MATH@` → Math function availability flag
- `@MAKE@` → detected make program
- `@INSTALL@` → detected install program
- `@MAKE_GMP@` → `make-gmp` or empty
- `@INSTALL_GMP@` → `install-gmp` or empty

## Makefile Structure

### Root Makefile

**Location**: `Makefile.in` (template), `Makefile` (generated)

**Key variables** (from Makefile.in:54-103):

**Version**:
```make
VERSION = 0.9.1
```

**Directories**:
```make
srcdir = @srcdir@          # Source directory (must be absolute)
gmpdir = $(srcdir)/gmp     # GMP library directory
```

**Installation directories**:
```make
prefix = /usr/local
bindir = $(exec_prefix)/bin
libdir = $(exec_prefix)/lib/agents$(VERSION)/lib
datadir = $(prefix)/lib/agents$(VERSION)
compilerdir = $(datadir)/compiler
demosdir = $(datadir)/demos
librarydir = $(datadir)/library
mandir = $(prefix)/man/man1
infodir = $(prefix)/info
```

**Tools**:
```make
CC = @CC@
CFLAGS = @CFLAGS@ -Wno-implicit-int -Wno-implicit-function-declaration
BISON = /opt/homebrew/opt/bison/bin/bison
FLEX = flex
M4 = m4
MAKEINFO = makeinfo
RUNTEST = runtest
```

**AGENTSFLAGS variants** (from Makefile.in:106-113):
```make
# E for Environment field in records
EAGENTSFLAGS = $(AGENTSFLAGS_AUTO) -DMETERING -DNDEBUG -DSTRUCT_ENV

# O for Ordinary
OAGENTSFLAGS = $(AGENTSFLAGS_AUTO) -DMETERING -DNDEBUG

# S for Script (used in the agents script)
SAGENTSFLAGS = $(AGENTSFLAGS_AUTO) -DNDEBUG -I$(srcdir)/emulator

# T for Trace
TAGENTSFLAGS = $(AGENTSFLAGS_AUTO) -DMETERING -DNDEBUG -DTRACE -g
```

Three emulator variants:
- **oagents**: Ordinary (production build)
- **eagents**: With STRUCT_ENV (alternative data representation)
- **tagents**: With tracing enabled

### Build Targets

**From Makefile.in:156-157**:

**`all`**: Default target
```make
all: @MAKE_GMP@ make-emulator make-compiler make-environment \
     make-version make-agents make-library make-tools make-demos
```

**Dependencies**:
1. **make-gmp**: Build GMP library (if not `--without-gmp`)
2. **make-emulator**: Build `oagents` executable
3. **make-compiler**: Compile compiler from AKL source
4. **make-environment**: Compile environment from AKL source
5. **make-version**: Generate `version.pam` with version info
6. **make-agents**: Generate `agents` wrapper script
7. **make-library**: Compile standard library
8. **make-tools**: Build development tools
9. **make-demos**: Compile demo programs

#### make-gmp (lines 159-161)

```make
make-gmp:
	(cd gmp; \
	 $(MAKE) $(MFLAGS) CC=$(CC) libgmp.a)
```

**Note**: Disabled by `--without-gmp` (sets `@MAKE_GMP@` to empty).

#### make-emulator (lines 163-168)

```make
make-emulator:
	(cd emulator; \
	 $(MAKE) $(MFLAGS) $(VARS_TO_PASS) VARS_TO_PASS='$(VARS_TO_PASS)' \
	         AGENTSFLAGS="$(OAGENTSFLAGS)" agents; \
	 mv agents.o oagents.o; \
	 mv agents oagents)
```

**Process**:
1. Enter emulator directory
2. Build `agents` executable with ordinary flags
3. Rename to `oagents` (ordinary agents)

#### make-compiler (lines 170-174)

```make
make-compiler:
	(cd oldcompiler; \
	 $(MAKE) $(MFLAGS) $(VARS_TO_PASS) AGENTS="$(WORKINGCOPY)" \
	         VARS_TO_PASS='$(VARS_TO_PASS) AGENTS="$(WORKINGCOPY)"' \
	         compiler)
```

**Bootstrapping**: Uses existing `agents` executable to compile the compiler from AKL source.

#### make-version (lines 182-190)

```make
make-version:
	echo \
"% WARNING: Do not edit this file; version.pam.in is the source file." \
	     > version.pam
	sed -e "s%--VERSION--%$(VERSION)%" \
	    -e "s%--DATE--%`date`%" \
	    -e "s%--DEMOSDIR--%$(srcdir)/demos%" \
	    -e "s%--LIBRARYDIR--%$(srcdir)/library%" \
	    version.pam.in >> version.pam
```

**Generates**: `version.pam` with version number, build date, and directories.

#### make-agents (lines 192-211)

```make
make-agents: agents.in
	echo \
"#! /bin/csh -f" \
	     > agents
	echo \
"# WARNING: Do not edit this file; agents.in is the source file." \
	     >> agents
	sed -e "s%##%  %" \
	    -e "s%--AGENTSEXE--%$(srcdir)/emulator/oagents%" \
	    -e "s%--AGENTSOBJ--%$(srcdir)/emulator/oagents.o%" \
	    -e "s%--COMPILERDIR--%$(srcdir)/oldcompiler%" \
	    -e "s%--EMULATORDIR--%$(srcdir)/emulator%" \
	    -e "s%--ENVIRONMENTDIR--%$(srcdir)/environment%" \
	    -e "s%--VERSION--%$(srcdir)/version.pam%" \
	    -e "s%--CC--%$(CC)%" \
	    -e "s%--CFLAGS--%$(ALL_CFLAGS)%" \
	    -e "s%--LDFLAGS--%$(LDFLAGS)%" \
	    -e "s%--AGENTSFLAGS--%$(SAGENTSFLAGS)%" \
	    agents.in >> agents
	chmod +x agents
```

**Generates**: `agents` shell script (wrapper) that:
1. Sets up environment
2. Invokes emulator with correct paths
3. Supports compilation and loading

### Emulator Makefile

**Location**: `emulator/Makefile` (not template!)

**Structure** (from emulator/Makefile:1-150):

**Object files** (lines 18-59):
```make
OBJ = abstraction.o \
      aggregate.o \
      array.o \
      bam.o \
      bignum.o \
      builtin.o \
      candidate.o \
      code.o \
      ...
```

**39 C source files** compiled to `.o` objects.

**Header files** (lines 61-116):
```make
DEF = abstraction.h \
      aggregate.h \
      array.h \
      ...
```

**47 header files** (dependencies for all objects).

**Build rules**:

```make
agents: agents.o foreign_stub.o
	${CC} $(CFLAGS) $(AGENTSFLAGS) agents.o foreign_stub.o $(LDFLAGS) \
	      -o agents

agents.o: $(OBJ)
	ld -r -o agents.o $(OBJ)

$(OBJ): $(DEF)

.c.o:
	$(CC) -c $(CFLAGS) $(AGENTSFLAGS) $< -o $@
```

**Process**:
1. Compile each `.c` file to `.o` (depends on all headers)
2. Link all objects into single `agents.o` (relocatable)
3. Link `agents.o` with `foreign_stub.o` to create executable

**Generated files** (lines 131-142):

**parser.y** (from M4):
```make
parser.y: parser.y.m4
	$(M4) $(M4FLAGS) parser.y.m4 > parser.y
```

**parser.tab.c** (from Bison):
```make
parser.tab.c parser.tab.h: parser.y
	$(BISON) -d $(BISONFLAGS) parser.y
```

**parser.yy.c** (from Flex):
```make
parser.yy.c: parser.l parser.tab.h
	$(FLEX) $(FLEXFLAGS) parser.l
	mv lex.yy.c parser.yy.c
```

**display.c** (from M4):
```make
display.c: display.c.m4
	$(M4) $(M4FLAGS) display.c.m4 > display.c
```

**Why M4?** Allows code generation and metaprogramming for repetitive parser rules and display formatting.

### Build Dependencies

**Dependency chain**:

```
configure.in → [autoconf] → configure
Makefile.in → [configure] → Makefile
*.c + *.h → [gcc] → *.o
*.o → [ld -r] → agents.o
agents.o + foreign_stub.o → [gcc] → agents (executable)
*.akl → [agents (bootstrap)] → *.pam (compiler, library)
agents.in → [sed] → agents (script)
version.pam.in → [sed] → version.pam
```

**Circular dependency**: Compiler is written in AKL, but you need AGENTS to compile AKL.

**Solution**: Distribution includes pre-compiled `boot.pam` containing the compiler. The build process uses the emulator + boot.pam to compile the compiler source.

## Installation

### Install Target

**From Makefile.in:226-229**:
```make
install: installdirs @INSTALL_GMP@ install-emulator install-compiler \
         install-environment install-version install-agents \
         install-library install-tools install-demos install-man \
         install-info install-emacs-mode
```

**Process**:
1. Create installation directories
2. Install GMP library (if built)
3. Install emulator (executable and headers)
4. Install compiler (.pam files)
5. Install environment (.pam files)
6. Install version information
7. Install wrapper script
8. Install standard library
9. Install tools
10. Install demos
11. Install man page
12. Install info documentation
13. Install Emacs mode

### Installation Directories

**From Makefile.in:62-83**:

**Default layout** (`--prefix=/usr/local`):
```
/usr/local/
├── bin/
│   ├── agents              # Wrapper script
│   ├── agents.e            # Emulator executable (oagents)
│   └── agents.o            # Relocatable object (oagents.o)
├── lib/agents0.9.1/
│   ├── compiler/           # Compiler .pam files
│   ├── demos/              # Demo programs
│   ├── emulator/           # Emulator headers
│   ├── environment/        # Environment .pam files
│   ├── library/            # Standard library .pam files
│   ├── lib/                # GMP library (if built)
│   ├── include/            # GMP headers (if built)
│   ├── version.pam         # Version information
│   ├── akl.el              # Emacs AKL mode
│   └── comint.el           # Emacs comint support
├── man/man1/
│   └── agents.1            # Man page
└── info/
    └── agents.info*        # Info documentation
```

**Custom prefix**:
```sh
./configure --prefix=/opt/agents
```

Installs everything under `/opt/agents` instead.

### Installed Emulator

**From Makefile.in:254-258**:
```make
install-emulator:
	(cd emulator; \
	 $(INSTALL_PROGRAM) oagents.o $(bindir)/agents.o; \
	 $(INSTALL_PROGRAM) oagents $(bindir)/agents.e; \
	 $(INSTALL_DATA) *.h $(emulatordir))
```

**Three pieces**:
1. **agents.o**: Relocatable object for foreign function linking
2. **agents.e**: Emulator executable
3. **\*.h**: Headers for foreign function development

### Installed Script

**From Makefile.in:279-303**:

**Tricky**: Installation version of script uses **installed** paths, not build paths.

```make
install-agents: agents.in
	sed -e "s%--AGENTSEXE--%$(bindir)/agents.e%" \
	    -e "s%--AGENTSOBJ--%$(bindir)/agents.o%" \
	    -e "s%--COMPILERDIR--%$(compilerdir)%" \
	    -e "s%--EMULATORDIR--%$(emulatordir)%" \
	    -e "s%--ENVIRONMENTDIR--%$(environmentdir)%" \
	    -e "s%--VERSION--%$(datadir)/version.pam%" \
	    ...
```

**Result**: Installed script points to installed directories, not build directories.

## Uninstallation

**From Makefile.in:333-385**:

```make
uninstall: uninstall-gmp uninstall-emulator uninstall-compiler \
           uninstall-environment uninstall-version uninstall-agents \
           uninstall-library uninstall-tools uninstall-demos \
           uninstall-man uninstall-info
```

**Example** (emulator):
```make
uninstall-emulator:
	rm -f $(bindir)/agents.o \
	      $(bindir)/agents.e \
	      $(emulatordir)/*.h
```

**Simple**: Just removes files installed by corresponding install target.

## Cleaning Targets

### clean (line 388)

```make
clean:
	(cd gmp; $(MAKE) $(MFLAGS) clean)
	(cd emulator; $(MAKE) $(MFLAGS) clean; \
	 rm -f oagents.o oagents tcovagents.o tcovagents)
	(cd oldcompiler; $(MAKE) $(MFLAGS) clean)
	(cd environment; $(MAKE) $(MFLAGS) clean)
	rm -f version.pam agents
	(cd library; $(MAKE) $(MFLAGS) clean)
	(cd tools; $(MAKE) $(MFLAGS) clean)
	(cd demos; $(MAKE) $(MFLAGS) clean)
	(cd doc; $(MAKE) $(MFLAGS) clean)
	(cd tests; rm -f agents.log agents.sum unique_name)
```

**Removes**: Object files, executables, generated files, test outputs.

**Preserves**: Distribution files, configure-generated files, documentation.

### mostlyclean (line 411)

```make
mostlyclean: clean
```

**Same as clean** for AGENTS (no time-consuming builds to preserve).

### distclean (line 414)

```make
distclean: clean
	rm -f Makefile config.status
```

**Removes**: Everything configure created.

**After distclean**: Must run `./configure` again.

### realclean (line 418)

```make
realclean: distclean
	(cd emulator; $(MAKE) $(MFLAGS) realclean)
	(cd oldcompiler; $(MAKE) $(MFLAGS) realclean)
	...
```

**WARNING** (from Makefile.in:29-34):
> THIS REMOVES THINGS IN THE DISTRIBUTION, SO NEVER DO THIS UNLESS YOU HAVE THE FOLLOWING UTILITIES, NECESSARY TO REBUILD THE DISTRIBUTION:
> bison flex m4 makeinfo

**Removes**:
- Generated parser files (parser.y, parser.tab.c, parser.yy.c)
- Generated display.c
- Info documentation
- Bootstrapping .pam files

**Use case**: Maintainers rebuilding distribution from scratch.

## Testing

### check Target (line 464)

```make
check:
	(cd tests; \
	 $(RUNTEST) $(RUNTESTFLAGS) --tool agents AGENTS=../agents)
```

**Uses DejaGnu** (`runtest` command) to run test suite.

**Requirements**:
- DejaGnu installed
- `agents` script built

**Output**:
- `tests/agents.log`: Detailed test log
- `tests/agents.sum`: Summary of passes/failures

### check-coverage Target (line 469)

```make
check-coverage: make-tcovagents test-tcovagents tcov-tcovagents

make-tcovagents:
	(cd emulator; \
	 $(MAKE) $(MFLAGS) $(VARS_TO_PASS) \
	         AGENTSFLAGS="$(OAGENTSFLAGS) -a" clean agents; \
	 mv agents.o tcovagents.o; \
	 mv agents tcovagents)

test-tcovagents:
	(cd tests; \
	 $(RUNTEST) $(RUNTESTFLAGS) --tool agents AGENTS="../agents -tcov")

tcov-tcovagents:
	(cd emulator; \
	 ls *.d | sed "s/\.d/\.c/" | xargs tcov; \
	 cat *.tcov > ../agents.tcov)
	echo "See agents.tcov for tcov-format profile."
```

**Process**:
1. Build emulator with `-a` flag (profiling instrumentation)
2. Run tests with profiling enabled
3. Generate coverage report with `tcov`

**Requirements**: SunOS `tcov` tool (legacy, may not work on modern systems).

## Special Build Targets

### eagents, oagents, tagents (lines 489-508)

**Three emulator variants**:

**eagents** (Environment in structures):
```make
eagents:
	(cd emulator; \
	 $(MAKE) $(MFLAGS) $(VARS_TO_PASS) \
	         AGENTSFLAGS="$(EAGENTSFLAGS)" clean agents; \
	 mv agents.o eagents.o; \
	 mv agents eagents)
```

**Flags**: `-DMETERING -DNDEBUG -DSTRUCT_ENV`

**Purpose**: Alternative data representation with environment stored in records.

**oagents** (Ordinary):
```make
oagents:
	(cd emulator; \
	 $(MAKE) $(MFLAGS) $(VARS_TO_PASS) \
	         AGENTSFLAGS="$(OAGENTSFLAGS)" clean agents; \
	 mv agents.o oagents.o; \
	 mv agents oagents)
```

**Flags**: `-DMETERING -DNDEBUG`

**Purpose**: Production build (default).

**tagents** (Trace):
```make
tagents:
	(cd emulator; \
	 $(MAKE) $(MFLAGS) $(VARS_TO_PASS) \
	         AGENTSFLAGS="$(TAGENTSFLAGS)" clean agents; \
	 mv agents.o tagents.o; \
	 mv agents tagents)
```

**Flags**: `-DMETERING -DNDEBUG -DTRACE -g`

**Purpose**: Debugging build with tracing enabled.

## Modern Compiler Compatibility

### The -fgnu89-inline Issue

**Problem**: Modern GCC (5.0+) changed inline semantics to C99 standard. AGENTS code uses GCC's legacy inline behavior.

**Symptom**: Link errors with multiple definitions:
```
multiple definition of `inline_function'
```

**Solution** (from emulator/Makefile:8):
```make
CFLAGS = -g -fgnu89-inline
```

**Effect**: Tells GCC to use pre-C99 inline semantics.

**Why necessary**: AGENTS headers use inline functions extensively. Legacy inline semantics:
- Inline definition in header generates external symbol
- Multiple definitions are allowed (linker picks one)

C99 semantics:
- Inline definition in header does NOT generate external symbol
- Causes "undefined reference" if function not inlined

**Compatibility**: Works on GCC 4.3+ (when flag was introduced).

### Other Modern Warnings

**From Makefile.in:92**:
```make
CFLAGS = @CFLAGS@ -Wno-implicit-int -Wno-implicit-function-declaration -Wno-int-conversion
```

**Suppressed warnings**:
- **-Wno-implicit-int**: Functions without return type (legacy C)
- **-Wno-implicit-function-declaration**: Functions used before declaration
- **-Wno-int-conversion**: Implicit int/pointer conversions

**Reason**: AGENTS code is 1990s-era C with pre-ANSI conventions. These warnings are harmless but numerous.

## Platform-Specific Considerations

### HP-UX

**From configure.in:100-124**:

**Issues**:
1. Missing hyperbolic functions (asinh, acosh, atanh)
2. Nonstandard make (doesn't support common GNU make features)

**Workarounds**:
1. Use `-DNOASINH` flag
2. Prefer `gmake` over `make`

### Solaris/SunOS

**Issues**:
1. `/usr/ucb/cc` vs `/opt/SUNWspro/bin/cc`
2. Different library paths

**Detection**: configure script tries multiple compilers.

### IRIX (SGI)

**Issues**:
1. MIPS architecture register definitions
2. Different inline semantics

**Handled by**: `regdefs.h` and compiler detection.

### Modern Linux (x86-64, ARM64)

**Issues**:
1. GMP library won't compile (1990s code)
2. Inline semantics changed
3. Stricter warnings

**Solutions**:
1. Use `--without-gmp`
2. Use `-fgnu89-inline`
3. Suppress legacy warnings

## Building from Distribution

### Prerequisites

**Required**:
- C compiler (gcc or clang)
- make (GNU make preferred)
- Standard UNIX utilities (sed, test, echo, date)

**Optional** (for rebuilding distribution files):
- bison (for parser generation)
- flex (for lexer generation)
- m4 (for code generation)
- makeinfo (for documentation)
- DejaGnu (for testing)

### Standard Build

**From README:80**:

```sh
./configure --without-gmp
make
```

**Time**: 2-5 minutes on modern system.

**Disk space**: ~8 MB.

### Installation

```sh
./configure --prefix=/opt/agents --without-gmp
make
sudo make install
```

**Result**: Installed AGENTS in `/opt/agents/`.

**Usage after install**:
```sh
/opt/agents/bin/agents
```

### Build Directory Support

**From Makefile.in:1-3**:
> The AGENTS Makefiles do not support building in directories other than the source directory.

**Workaround**: `mkbuilddirs` script creates build directory with symlinks to source.

**Example**:
```sh
./mkbuilddirs `pwd` ../rs6000
cd ../rs6000
./configure
make
```

**Use case**: Multiple platforms sharing source tree.

## Extending the Build System

### Adding a New Platform

**Step 1**: Ensure `config.guess` recognizes platform
- Test: `./config.guess`
- If fails, update `config.guess` or specify `--host` explicitly

**Step 2**: Add platform-specific configuration to `configure.in`

**Example** (hypothetical RISC-V):
```sh
case ${host} in
  riscv64-* )
    AGENTSFLAGS_MATH=""
    LDFLAGS_MATH=-lm
    # Any platform-specific flags here
  ;;
  * )
    AGENTSFLAGS_MATH=""
    LDFLAGS_MATH=-lm
  ;;
esac
```

**Step 3**: Add register definitions to `emulator/regdefs.h` (see Chapter 20)

**Step 4**: Test build:
```sh
./configure --host=riscv64-unknown-linux-gnu --without-gmp
make
make check
```

### Adding Compile-Time Options

**Step 1**: Add AC_ARG_WITH or AC_ARG_ENABLE to `configure.in`

**Example**:
```sh
AC_ARG_WITH(new-feature,
  [  --with-new-feature      Enable new feature],
  [new_feature=$withval],
  [new_feature=no])

if test "$new_feature" = "yes"; then
  AGENTSFLAGS_FEATURE="-DNEW_FEATURE"
else
  AGENTSFLAGS_FEATURE=""
fi

AC_SUBST(AGENTSFLAGS_FEATURE)
```

**Step 2**: Use in Makefile.in:
```make
AGENTSFLAGS_AUTO = @AGENTSFLAGS_GMP@ @AGENTSFLAGS_MATH@ @AGENTSFLAGS_FEATURE@
```

**Step 3**: Regenerate configure:
```sh
autoconf configure.in > configure
chmod +x configure
```

## Summary

The AGENTS build system is a traditional **autoconf-based** system with:

**Strengths**:
- **Platform detection**: Automatically configures for different UNIX systems
- **Feature detection**: Handles missing libraries and functions gracefully
- **Hierarchical**: Separate Makefiles for each component
- **Standard targets**: `all`, `install`, `clean`, `check` follow GNU conventions
- **Bootstrapping**: Compiles compiler from AKL source using pre-compiled boot image

**Weaknesses**:
- **1990s design**: Requires modern compatibility flags (`-fgnu89-inline`)
- **GMP incompatibility**: Bundled library doesn't compile on modern systems
- **Limited platforms**: Primarily UNIX-focused (no native Windows support)
- **No out-of-tree builds**: Must build in source directory (or use symlinks)

**Modern usage**:
```sh
./configure --without-gmp --prefix=/usr/local
make
make check
sudo make install
```

**Key insight**: The build system's simplicity (autoconf + make) and careful platform abstraction allowed AGENTS to port successfully from 32-bit SPARC (1990s) to 64-bit x86-64 and ARM64 (2020s) with minimal changes to the build infrastructure itself. The main updates needed were:
1. Register definitions (`regdefs.h`)
2. Compiler compatibility flags (`-fgnu89-inline`)
3. Library exclusions (`--without-gmp`)

The next chapter covers the test suite that validates the system works correctly across platforms.

---

**Chapter 21 complete** (~40 pages)
